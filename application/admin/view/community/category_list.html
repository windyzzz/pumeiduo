<include file="public/layout"/>
<body style="background-color: rgb(255, 255, 255); overflow: auto; cursor: default;">
<div class="page">
    <div class="fixed-bar">
        <div class="item-title">
            <div class="subject">
                <h3>商学院分类</h3>
                <h5>商学院分类添加与管理</h5>
            </div>
        </div>
    </div>
    <div id="explanation" class="explanation">
        <div id="checkZoom" class="title"><i class="fa fa-lightbulb-o"></i>
            <h4 title="提示相关设置操作时应注意的要点">操作提示</h4>
            <span title="收起提示" id="explanationZoom"></span>
        </div>
        <ul>
            <li>温馨提示：顶级分类（一级大类）设为推荐时才会在商学院顶部显示</li>
            <li>最多只能分类到二级</li>
        </ul>
    </div>
    <form method="post">
        <input type="hidden" value="ok" name="form_submit">
        <div class="flexigrid">
            <div class="mDiv">
                <div class="ftitle">
                    <h3>商学院分类列表</h3>
                    <h5></h5>
                </div>
            </div>
            <div class="hDiv">
                <div class="hDivBox">
                    <table cellspacing="0" cellpadding="0">
                        <thead>
                        <tr>
                            <th align="center" axis="col0" class="sign">
                                <div style="text-align: center; width: 24px;"><i class="ico-check"></i></div>
                            </th>
                            <th align="center" axis="col1" class="handle">
                                <div style="text-align:center; min-width:300px !important; max-width:inherit !important;">操作</div>
                            </th>
                            <th align="center" axis="col2">
                                <div style="text-align: center; width: 60px;">分类id</div>
                            </th>
                            <th align="center" axis="col3">
                                <div style="text-align: center; width: 200px;">分类名称</div>
                            </th>
                            <th align="center" axis="col6">
                                <div style="text-align: center; width: 80px;">是否显示</div>
                            </th>
                            <th align="center" axis="col6">
                                <div style="text-align: center; width: 150px;">普通用户下能否发布文章</div>
                            </th>
                            <th align="center" axis="col9">
                                <div style="text-align: center; width: 60px;">排序</div>
                            </th>
                            <th axis="col10">
                                <div style="width: 100%;"></div>
                            </th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div class="tDiv">
                <div class="tDiv2">
                    <div class="fbutton">
                        <a href="{:U('Community/category', array('act'=>'add'))}">
                            <div title="新增分类" class="add">
                                <span><i class="fa fa-plus"></i>新增分类</span>
                            </div>
                        </a>
                    </div>
                    <div class="fbutton">
                        <div class="add" title="收缩分类">
                            <span onclick="tree_open(this);"><i class="fa fa-angle-double-up"></i>收缩分类</span>
                        </div>
                    </div>
                </div>
                <div style="clear:both"></div>
            </div>
            <div style="height: auto;" class="bDiv" id="flexigrid" data-url="{:U('Community/category', array('act'=>'del'))}">
                <table cellspacing="0" cellpadding="0" border="0" id="article_cat_table" class="flex-table autoht">
                    <tbody id="treet1">
                    <foreach name="cate_list" item="vo" key="k">
                        <tr data-level="{$vo[level]}" class="parent_id_{$vo.parent_id}" id="{$vo.level}_{$vo.id}">
                            <td class="sign">
                                <div style="text-align: center; width: 24px;">
                                    <img src="/public/static/images/tv-collapsable-last.gif" fieldid="2" status="open"
                                         id="icon_{$vo.level}_{$vo.id}" onClick="treeClicked(this,{$vo[id]})">
                                </div>
                            </td>
                            <td class="handle">
                                <div style="text-align:center; min-width:300px !important; max-width:inherit !important;">
                                    <span style="margin-left:<?php echo ($vo[level] * 3); ?>em" class="btn">
                                        <em><i class="fa fa-cog"></i>设置<i class="arrow"></i></em>
                                        <ul>
                                            <li><a href="{:U('Community/category', array('act'=>'edit','id'=>$vo['id']))}">编辑分类信息</a></li>
                                            <if condition="$vo[level] lt 1">
                                                <li><a href="{:U('Community/category', array('act'=>'add','parent_id'=>$vo['id']))}">新增下级分类</a></li>
                                            </if>
                                            <li><a href="javascript:;" onclick="publicHandle({$vo['id']})">删除当前分类</a></li>
                                        </ul>
                                    </span>
                                </div>
                            </td>
                            <td class="sort">
                                <div style="text-align: center; width: 60px;">{$vo.id}</div>
                            </td>
                            <td class="name">
                                <div style="text-align: center; width: 200px;">
                                    <input type="text" value="{$vo.cate_name}"
                                           onblur="changeTableVal('community_category','id','{$vo.id}','cate_name',this)"
                                           style="text-align: left; width:180px;"/>
                                </div>
                            </td>
                            <td align="center" class="">
                                <div style="text-align: center; width: 80px;">
                                    <if condition='$vo[status] eq 1'>
                                        <span class="yes"
                                              onClick="changeTableVal('community_category','id','{$vo.id}','status',this)"><i
                                                class="fa fa-check-circle"></i>是</span>
                                        <else/>
                                        <span class="no"
                                              onClick="changeTableVal('community_category','id','{$vo.id}','status',this)"><i
                                                class="fa fa-ban"></i>否</span>
                                    </if>
                                </div>
                            </td>
                            <td align="center" class="">
                                <div style="text-align: center; width: 150px;">
                                    <if condition='$vo[user_can_publish] eq 1'>
                                        <span class="yes"
                                              onClick="changeTableVal('community_category','id','{$vo.id}','user_can_publish',this)"><i
                                                class="fa fa-check-circle"></i>是</span>
                                        <else/>
                                        <span class="no"
                                              onClick="changeTableVal('community_category','id','{$vo.id}','user_can_publish',this)"><i
                                                class="fa fa-ban"></i>否</span>
                                    </if>
                                </div>
                            </td>
                            <td class="sort">
                                <div style="text-align: center; width: 60px;">
                                    <input type="text" onKeyUp="this.value=this.value.replace(/[^\d]/g,'')"
                                           onpaste="this.value=this.value.replace(/[^\d]/g,'')"
                                           onblur="changeTableVal('community_category','id','{$vo.id}','sort',this)"
                                           size="4" value="{$vo.sort}"/>
                                </div>
                            </td>
                            <td style="width: 100%;">
                                <div>&nbsp;</div>
                            </td>
                        </tr>
                    </foreach>
                    </tbody>
                </table>
            </div>
        </div>
</div>
<script>
    $(document).ready(function () {
        // 表格行点击选中切换
        $('.bDiv > table>tbody >tr').click(function () {
            $(this).toggleClass('trSelected');
        });
    });

    // 点击展开 收缩节点
    function tree_open(obj) {
        var tree = $('#article_cat_table tr[id^="1_"]'); //,'table-row'
        if (tree.css('display') == 'table-row') {
            $(obj).html("<i class='fa fa-angle-double-down'></i>展开分类");
            tree.css('display', 'none');
            $("img[id^='icon_']").attr('src', '/public/static/images/tv-expandable.gif');
        } else {
            $(obj).html("<i class='fa fa-angle-double-up'></i>收缩分类");
            tree.css('display', 'table-row');
            $("img[id^='icon_']").attr('src', '/public/static/images/tv-collapsable-last.gif');
        }
    }

    function treeClicked(obj, cat_id) {
        var src = $(obj).attr('src');
        if (src == '/public/static/images/tv-expandable.gif') {
            $(".parent_id_" + cat_id).show();
            $(obj).attr('src', '/public/static/images/tv-collapsable-last.gif');
        } else {
            $(obj).attr('src', '/public/static/images/tv-expandable.gif');

            // 如果是点击减号, 遍历循环他下面的所有都关闭
            var tbl = document.getElementById("article_cat_table");
            cur_tr = obj.parentNode.parentNode.parentNode;
            var fnd = false;
            for (i = 0; i < tbl.rows.length; i++) {
                var row = tbl.rows[i];

                if (row == cur_tr) {
                    fnd = true;
                } else {
                    if (fnd == true) {

                        var level = parseInt($(row).data('level'));
                        var cur_level = $(cur_tr).data('level');

                        if (level > cur_level) {
                            $(row).hide();
                            $(row).find('img').attr('src', '/public/static/images/tv-expandable.gif');
                        } else {
                            fnd = false;
                            break;
                        }
                    }
                }
            }
        }
    }
</script>
</body>
</html>